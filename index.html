<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Crane Worksheet</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
body {
    font-family: 'Poppins', sans-serif;
    background:#f4f6f9;
    padding:15px;
}
.card {
    background:white;
    padding:15px;
    border-radius:10px;
    box-shadow:0 4px 10px rgba(0,0,0,0.05);
    margin-bottom:15px;
}
input, select {
    width:100%;
    padding:8px;
    margin:5px 0;
    border-radius:6px;
    border:1px solid #ccc;
}
button {
    width:100%;
    padding:10px;
    margin-top:10px;
    border:none;
    border-radius:6px;
    font-weight:600;
    cursor:pointer;
}
.primary { background:#2b7cff; color:white; }
.danger { background:#e74c3c; color:white; }
table {
    width:100%;
    border-collapse: collapse;
    font-size:12px;
}
th, td {
    padding:6px;
    border-bottom:1px solid #eee;
    text-align:left;
}
th { background:#fafafa; }
.summary-box {
    background:#2b7cff;
    color:white;
    padding:12px;
    border-radius:8px;
    text-align:center;
}
</style>
</head>

<body>

<h2>Crane Worksheet</h2>

<div class="card">
<h3>Entry</h3>

<input type="date" id="work_date">

<input list="clients" id="client" placeholder="Client">
<datalist id="clients"></datalist>

<input list="contractors" id="contractor" placeholder="Contractor">
<datalist id="contractors"></datalist>

<select id="crane_type">
<option>HYDRA</option>
<option>FARANA</option>
</select>

<select id="crane_no">
<option>GJ15SV1249</option>
<option>GJ15SV1677</option>
<option>GJ15SV1316</option>
<option>GJ15SV1315</option>
<option>GJ15SV1314</option>
</select>

<input list="assign_list" id="assign" placeholder="Assign Sir">
<datalist id="assign_list"></datalist>

<input type="time" id="in_time">
<input type="time" id="out_time">
<input type="number" id="lunch" value="0" placeholder="Lunch (minutes)">

<select id="rate_type">
<option>Hourly</option>
<option>Fixed</option>
</select>

<input type="number" id="rate" placeholder="Rate">

<input type="text" id="total_hours" placeholder="Total Hours" readonly>
<input type="text" id="unit" placeholder="Unit" readonly>
<input type="text" id="amount" placeholder="Amount" readonly>

<button class="primary" onclick="addRow()">Add Worksheet</button>
</div>

<div class="card">
<h3>Filter</h3>

<label>From Date</label>
<input type="date" id="from_date" onchange="renderTable()">

<label>To Date</label>
<input type="date" id="to_date" onchange="renderTable()">

<label>Contractor</label>
<select id="filter_contractor" onchange="renderTable()">
<option value="">ALL</option>
</select>

<label>Crane Type</label>
<select id="filter_crane_type" onchange="renderTable()">
<option value="">ALL</option>
<option>HYDRA</option>
<option>FARANA</option>
</select>
</div>

<div class="summary-box" id="summary">
Total Entries: 0 | Total Hours: 0 | Total Amount: ₹0
</div>

<div class="card">
<table id="table">
<thead>
<tr>
<th>Date</th>
<th>Client</th>
<th>Crane</th>
<th>Hours</th>
<th>Amount</th>
</tr>
</thead>
<tbody></tbody>
</table>

<button class="primary" onclick="generatePDF()">Generate PDF</button>
<button class="danger" onclick="clearAll()">Clear All</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
let rows = JSON.parse(localStorage.getItem("rows") || "[]");

function calculate(){
    let client = document.getElementById("client").value.toUpperCase();
    let crane = document.getElementById("crane_type").value;
    let inTime = document.getElementById("in_time").value;
    let outTime = document.getElementById("out_time").value;
    let lunch = parseFloat(document.getElementById("lunch").value || 0);
    let rateType = document.getElementById("rate_type").value;
    let rateField = document.getElementById("rate");

    if(!inTime || !outTime) return;

    let inDate = new Date("1970-01-01T" + inTime);
    let outDate = new Date("1970-01-01T" + outTime);
    if(outDate < inDate) outDate.setDate(outDate.getDate()+1);

    let hours = (outDate - inDate)/(1000*60*60) - lunch/60;
    hours = Math.max(hours,0);

    let amount=0, unit="";

    if(client==="ATUL LTD"){
        rateField.readOnly=true;
        if(crane==="HYDRA"){ rateField.value=750; unit="HOURS"; amount=hours*750; }
        else{
            if(hours<7){ rateField.value=1500; unit="HOURS"; amount=hours*1500; }
            else{ rateField.value=10000; unit="DAY"; amount=10000; }
        }
    }else{
        rateField.readOnly=false;
        let rate=parseFloat(rateField.value||0);
        if(rateType==="Hourly"){ unit="HOURS"; amount=hours*rate; }
        else{ unit="FIXED"; amount=rate; }
    }

    document.getElementById("total_hours").value=hours.toFixed(2);
    document.getElementById("unit").value=unit;
    document.getElementById("amount").value=amount.toFixed(2);
}

document.querySelectorAll("input, select").forEach(el=>{
    el.addEventListener("input",calculate);
});

function addRow(){
    calculate();

    let row={
        work_date:document.getElementById("work_date").value,
        client:document.getElementById("client").value,
        contractor:document.getElementById("contractor").value,
        crane_type:document.getElementById("crane_type").value,
        crane_no:document.getElementById("crane_no").value,
        total_hours:document.getElementById("total_hours").value,
        amount:document.getElementById("amount").value
    };

    rows.push(row);
    localStorage.setItem("rows",JSON.stringify(rows));
    renderTable();
}

function renderTable(){

    let from=document.getElementById("from_date").value;
    let to=document.getElementById("to_date").value;
    let contractor=document.getElementById("filter_contractor").value;
    let craneType=document.getElementById("filter_crane_type").value;

    let filtered=rows.filter(r=>{
        return (!from || r.work_date>=from)
        && (!to || r.work_date<=to)
        && (!contractor || r.contractor===contractor)
        && (!craneType || r.crane_type===craneType);
    });

    document.getElementById("filter_contractor").innerHTML=
        '<option value="">ALL</option>'+
        [...new Set(rows.map(r=>r.contractor))]
        .map(x=>`<option>${x}</option>`).join("");

    let tbody=document.querySelector("#table tbody");
    tbody.innerHTML=filtered.map(r=>`
        <tr>
        <td>${r.work_date}</td>
        <td>${r.client}</td>
        <td>${r.crane_no}</td>
        <td>${r.total_hours}</td>
        <td>${r.amount}</td>
        </tr>
    `).join("");

    let totalHours=filtered.reduce((a,b)=>a+parseFloat(b.total_hours||0),0);
    let totalAmount=filtered.reduce((a,b)=>a+parseFloat(b.amount||0),0);

    document.getElementById("summary").innerHTML=
        `Total Entries: ${filtered.length} | Total Hours: ${totalHours.toFixed(2)} | Total Amount: ₹${totalAmount.toFixed(2)}`;

    return filtered;
}

async function generatePDF(){
    const { jsPDF }=window.jspdf;
    const doc=new jsPDF();
    let filtered=renderTable();
    if(filtered.length===0){ alert("No data"); return; }

    doc.setFontSize(14);
    doc.text("Crane Worksheet Summary",14,15);

    let y=25;
    filtered.forEach(r=>{
        doc.text(`${r.work_date} | ${r.client} | ${r.crane_no} | ${r.total_hours} Hrs | ₹${r.amount}`,14,y);
        y+=8;
        if(y>280){ doc.addPage(); y=20; }
    });

    doc.save("worksheet_summary.pdf");
}

function clearAll(){
    if(confirm("Clear all data?")){
        rows=[];
        localStorage.removeItem("rows");
        renderTable();
    }
}

renderTable();
</script>

</body>
</html>
