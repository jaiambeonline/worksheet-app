<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Worksheet Entry</title>

<style>
body { font-family: Arial; padding: 15px; background:#f2f2f2; }
input, select { width:100%; padding:8px; margin:4px 0; }
button { padding:10px; margin-top:8px; width:100%; }
table { width:100%; border-collapse: collapse; margin-top:15px; font-size:12px;}
th, td { border:1px solid #ccc; padding:6px; }
th { background:#ddd; }
.section { background:white; padding:10px; margin-bottom:15px; border-radius:6px; }
h3 { margin-top:0; }
</style>
</head>

<body>

<h2>Worksheet Entry</h2>

<div class="section">

<label>Date</label>
<input type="date" id="work_date">

<label>Client</label>
<input list="clients" id="client">
<datalist id="clients"></datalist>

<label>Contractor</label>
<input list="contractors" id="contractor">
<datalist id="contractors"></datalist>

<label>Crane Type</label>
<select id="crane_type">
<option>HYDRA</option>
<option>FARANA</option>
</select>

<label>Crane No</label>
<select id="crane_no">
<option>GJ15SV1249</option>
<option>GJ15SV1677</option>
<option>GJ15SV1316</option>
<option>GJ15SV1315</option>
<option>GJ15SV1314</option>
</select>

<label>Assign Sir</label>
<input list="assign_list" id="assign">
<datalist id="assign_list"></datalist>

<label>In Time</label>
<input type="time" id="in_time">

<label>Out Time</label>
<input type="time" id="out_time">

<label>Lunch (minutes)</label>
<input type="number" id="lunch" value="0">

<label>Rate Type</label>
<select id="rate_type">
<option>Hourly</option>
<option>Fixed</option>
</select>

<label>Rate</label>
<input type="number" id="rate">

<label>Total Hours</label>
<input type="text" id="total_hours" readonly>

<label>Unit</label>
<input type="text" id="unit" readonly>

<label>Amount</label>
<input type="text" id="amount" readonly>

<button onclick="addRow()">Add Worksheet</button>

</div>

<table id="table">
<thead>
<tr>
<th>Date</th>
<th>Client</th>
<th>Crane</th>
<th>Hours</th>
<th>Amount</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div class="section">

<h3>Filter & Export</h3>

<label>Filter Contractor</label>
<select id="filter_contractor" onchange="renderTable()">
<option value="">ALL</option>
</select>

<label>Filter Assign Sir</label>
<select id="filter_assign" onchange="renderTable()">
<option value="">ALL</option>
</select>

<label>Filter Crane No</label>
<select id="filter_crane_no" onchange="renderTable()">
<option value="">ALL</option>
</select>

<label>Filter Crane Type</label>
<select id="filter_crane_type" onchange="renderTable()">
<option value="">ALL</option>
<option>HYDRA</option>
<option>FARANA</option>
</select>

<button onclick="generatePDF()">Generate PDF</button>
<button onclick="clearAll()">Clear All</button>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>

let rows = JSON.parse(localStorage.getItem("rows") || "[]");

function calculate(){

    let client = document.getElementById("client").value.toUpperCase();
    let crane = document.getElementById("crane_type").value;
    let inTime = document.getElementById("in_time").value;
    let outTime = document.getElementById("out_time").value;
    let lunch = parseFloat(document.getElementById("lunch").value || 0);
    let rateType = document.getElementById("rate_type").value;
    let rateField = document.getElementById("rate");

    if(!inTime || !outTime) return;

    let inDate = new Date("1970-01-01T" + inTime);
    let outDate = new Date("1970-01-01T" + outTime);

    if(outDate < inDate) outDate.setDate(outDate.getDate()+1);

    let hours = (outDate - inDate) / (1000*60*60);
    hours -= lunch/60;
    hours = Math.max(hours,0);

    let amount = 0;
    let unit = "";

    if(client === "ATUL LTD"){
        rateField.readOnly = true;

        if(crane === "HYDRA"){
            rateField.value = 750;
            unit = "HOURS";
            amount = hours * 750;
        }else{
            if(hours < 7){
                rateField.value = 1500;
                unit = "HOURS";
                amount = hours * 1500;
            }else{
                rateField.value = 10000;
                unit = "DAY";
                amount = 10000;
            }
        }
    }else{
        rateField.readOnly = false;
        let rate = parseFloat(rateField.value || 0);

        if(rateType === "Hourly"){
            unit = "HOURS";
            amount = hours * rate;
        }else{
            unit = "FIXED";
            amount = rate;
        }
    }

    document.getElementById("total_hours").value = hours.toFixed(2);
    document.getElementById("unit").value = unit;
    document.getElementById("amount").value = amount.toFixed(2);
}

document.querySelectorAll("input, select").forEach(el=>{
    el.addEventListener("input", calculate);
});

function addRow(){

    calculate();

    let row = {
        work_date: document.getElementById("work_date").value,
        client: document.getElementById("client").value,
        contractor: document.getElementById("contractor").value,
        crane_type: document.getElementById("crane_type").value,
        crane_no: document.getElementById("crane_no").value,
        assign: document.getElementById("assign").value,
        total_hours: document.getElementById("total_hours").value,
        amount: document.getElementById("amount").value
    };

    rows.push(row);
    localStorage.setItem("rows", JSON.stringify(rows));
    renderTable();
}

function updateFilters(){
    let contractors = [...new Set(rows.map(r => r.contractor))];
    let assigns = [...new Set(rows.map(r => r.assign))];
    let cranes = [...new Set(rows.map(r => r.crane_no))];

    document.getElementById("filter_contractor").innerHTML =
        '<option value="">ALL</option>' +
        contractors.map(x => `<option>${x}</option>`).join("");

    document.getElementById("filter_assign").innerHTML =
        '<option value="">ALL</option>' +
        assigns.map(x => `<option>${x}</option>`).join("");

    document.getElementById("filter_crane_no").innerHTML =
        '<option value="">ALL</option>' +
        cranes.map(x => `<option>${x}</option>`).join("");
}

function renderTable(){

    updateFilters();

    let fc = document.getElementById("filter_contractor").value;
    let fa = document.getElementById("filter_assign").value;
    let fcn = document.getElementById("filter_crane_no").value;
    let fct = document.getElementById("filter_crane_type").value;

    let filtered = rows.filter(r => 
        (!fc || r.contractor === fc) &&
        (!fa || r.assign === fa) &&
        (!fcn || r.crane_no === fcn) &&
        (!fct || r.crane_type === fct)
    );

    let tbody = document.querySelector("#table tbody");

    tbody.innerHTML = filtered.map(r=>`
        <tr>
        <td>${r.work_date}</td>
        <td>${r.client}</td>
        <td>${r.crane_no}</td>
        <td>${r.total_hours}</td>
        <td>${r.amount}</td>
        </tr>
    `).join("");

    return filtered;
}

async function generatePDF(){

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    let filtered = renderTable();

    if(filtered.length === 0){
        alert("No data to export");
        return;
    }

    let y = 20;
    let totalHours = 0;
    let totalAmount = 0;

    doc.setFontSize(14);
    doc.text("Worksheet Summary", 14, 10);

    doc.setFontSize(10);
    doc.text("Date   Client   Crane   Hours   Amount", 14, y);
    y += 6;

    filtered.forEach(r=>{
        doc.text(
            `${r.work_date}   ${r.client}   ${r.crane_no}   ${r.total_hours}   ${r.amount}`,
            14, y
        );
        y += 6;

        totalHours += parseFloat(r.total_hours);
        totalAmount += parseFloat(r.amount);

        if(y > 280){
            doc.addPage();
            y = 20;
        }
    });

    y += 10;
    doc.text(`Total Hours: ${totalHours.toFixed(2)}`, 14, y);
    y += 6;
    doc.text(`Total Amount: â‚¹ ${totalAmount.toFixed(2)}`, 14, y);

    doc.save("worksheet_summary.pdf");
}

function clearAll(){
    if(confirm("Clear all worksheets?")){
        rows = [];
        localStorage.removeItem("rows");
        renderTable();
    }
}

renderTable();

</script>

</body>
</html>
