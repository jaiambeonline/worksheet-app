<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Bhavishya Enterprise - Crane Worksheet</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { font-family:'Poppins',sans-serif; background:#f4f6f9; padding:15px; margin:0;}
.card { background:white; padding:18px; border-radius:14px; box-shadow:0 8px 25px rgba(0,0,0,0.08); margin-bottom:18px;}
.header { background:linear-gradient(135deg,#2b7cff,#004aad); color:white; text-align:center;}
.header h2 { margin:5px 0;}
.header p { margin:2px 0; font-size:13px;}
input,select { width:100%; padding:8px; margin:5px 0; border-radius:8px; border:1px solid #ccc;}
button { width:100%; padding:10px; margin-top:10px; border:none; border-radius:8px; font-weight:600; cursor:pointer;}
.primary { background:#2b7cff; color:white;}
.danger { background:#e74c3c; color:white;}
table { width:100%; border-collapse:collapse; font-size:12px;}
th,td { padding:8px; border-bottom:1px solid #eee;}
th { background:#fafafa; font-weight:600;}
.summary-box { background:#2b7cff; color:white; padding:14px; border-radius:10px; text-align:center; font-weight:600;}
.multi { height:70px; }
</style>
</head>

<body>

<div class="card header">
<h2>BHAVISHYA ENTERPRISE</h2>
<p>Shop No 5, T M Park, Mukund Parnera</p>
<p>Valsad - 396020</p>
<p>M: 8866995757</p>
<p>bhavishyaenterprisevalsad@gmail.com</p>
</div>

<div class="card">
<h3>Worksheet Entry</h3>

<input type="date" id="work_date">
<input id="client" placeholder="Client">
<input id="contractor" placeholder="Contractor">

<select id="crane_type">
<option>HYDRA</option>
<option>FARANA</option>
</select>

<select id="crane_no">
<option>GJ15SV1249</option>
<option>GJ15SV1677</option>
<option>GJ15SV1316</option>
<option>GJ15SV1315</option>
<option>GJ15SV1314</option>
</select>

<input id="assign" placeholder="Assign Sir">

<input type="time" id="in_time">
<input type="time" id="out_time">
<input type="number" id="lunch" value="0" placeholder="Lunch (minutes)">

<select id="rate_type">
<option>Hourly</option>
<option>Fixed</option>
</select>

<input type="number" id="rate" placeholder="Rate">
<input id="total_hours" placeholder="Total Hours" readonly>
<input id="unit" placeholder="Unit" readonly>
<input id="amount" placeholder="Amount" readonly>

<button class="primary" onclick="addRow()">Add Worksheet</button>
</div>

<div class="summary-box" id="summary">
HYDRA HRS: 0 | FARANA HRS: 0 | FARANA DAYS: 0 | TOTAL ₹: 0
</div>

<div class="card">

<h4>PDF Filters</h4>

<label>Contractor</label>
<select id="pdf_contractor">
<option value="">ALL</option>
</select>

<label>Assign Sir</label>
<select id="pdf_assign">
<option value="">ALL</option>
</select>

<label>Crane No</label>
<select id="pdf_crane_no">
<option value="">ALL</option>
</select>

<label>Crane Type</label>
<select id="pdf_crane_type">
<option value="">ALL</option>
<option>HYDRA</option>
<option>FARANA</option>
</select>

<label>From Date</label>
<input type="date" id="pdf_from">

<label>To Date</label>
<input type="date" id="pdf_to">


<table id="table">
<thead>
<tr>
<th>Date</th>
<th>Client</th>
<th>Contractor</th>
<th>Crane</th>
<th>Hours</th>
<th>Amount</th>
</tr>
</thead>
<tbody></tbody>
</table>

<button class="primary" onclick="exportExcel()">Export Excel</button>
<button class="primary" onclick="generatePDF()">Export PDF</button>
<button class="danger" onclick="clearAll()">Clear All</button>

</div>

<script>

let rows = JSON.parse(localStorage.getItem("rows") || "[]");

function calculate(){
    let client=document.getElementById("client").value.toUpperCase();
    let crane=document.getElementById("crane_type").value;
    let inTime=document.getElementById("in_time").value;
    let outTime=document.getElementById("out_time").value;
    let lunch=parseFloat(document.getElementById("lunch").value||0);
    let rateType=document.getElementById("rate_type").value;
    let rateField=document.getElementById("rate");

    if(!inTime||!outTime) return;

    let inDate=new Date("1970-01-01T"+inTime);
    let outDate=new Date("1970-01-01T"+outTime);
    if(outDate<inDate) outDate.setDate(outDate.getDate()+1);

    let hours=(outDate-inDate)/(1000*60*60)-lunch/60;
    hours=Math.max(hours,0);

    let amount=0,unit="",po="";

    if(client==="ATUL LTD"){
        rateField.readOnly=true;
        if(crane==="HYDRA"){ rateField.value=750; unit="HOURS"; amount=hours*750; po="9119720043"; }
        else{
            if(hours<7){ rateField.value=1500; unit="HOURS"; amount=hours*1500; po="9719720185"; }
            else{ rateField.value=10000; unit="DAY"; amount=10000; po="9719720186"; }
        }
    }else{
        rateField.readOnly=false;
        let rate=parseFloat(rateField.value||0);
        if(rateType==="Hourly"){ unit="HOURS"; amount=hours*rate; }
        else{ unit="FIXED"; amount=rate; }
    }

    document.getElementById("total_hours").value=hours.toFixed(2);
    document.getElementById("unit").value=unit;
    document.getElementById("amount").value=amount.toFixed(2);

    return {po};
}

function addRow(){
    let calc=calculate();
    let row={
        work_date:document.getElementById("work_date").value,
        client:document.getElementById("client").value,
        contractor:document.getElementById("contractor").value,
        crane_type:document.getElementById("crane_type").value,
        crane_no:document.getElementById("crane_no").value,
        assign:document.getElementById("assign").value,
        in_time:document.getElementById("in_time").value,
        out_time:document.getElementById("out_time").value,
        lunch:document.getElementById("lunch").value,
        total_hours:document.getElementById("total_hours").value,
        unit:document.getElementById("unit").value,
        rate:document.getElementById("rate").value,
        amount:document.getElementById("amount").value,
        po:calc?calc.po:""
    };
    rows.push(row);
    localStorage.setItem("rows",JSON.stringify(rows));
    renderTable();
}

function populateFilters(){

    function setOptions(id, values){
        const select = document.getElementById(id);
        select.innerHTML = '<option value="">ALL</option>' +
            values.map(v=>`<option value="${v}">${v}</option>`).join("");
    }

    setOptions("pdf_contractor", [...new Set(rows.map(r=>r.contractor))]);
    setOptions("pdf_assign", [...new Set(rows.map(r=>r.assign))]);
    setOptions("pdf_crane_no", [...new Set(rows.map(r=>r.crane_no))]);
}

function renderTable(){
    populateFilters();
    let tbody=document.querySelector("#table tbody");
    tbody.innerHTML=rows.map(r=>`
        <tr>
        <td>${r.work_date}</td>
        <td>${r.client}</td>
        <td>${r.contractor}</td>
        <td>${r.crane_no}</td>
        <td>${r.total_hours}</td>
        <td>${r.amount}</td>
        </tr>`).join("");

    let hydra=0,faranaH=0,faranaD=0,totalAmt=0;
    rows.forEach(r=>{
        if(r.po==="9119720043") hydra+=parseFloat(r.total_hours||0);
        if(r.po==="9719720185") faranaH+=parseFloat(r.total_hours||0);
        if(r.po==="9719720186") faranaD+=1;
        totalAmt+=parseFloat(r.amount||0);
    });

    document.getElementById("summary").innerHTML=
    `HYDRA HRS: ${hydra.toFixed(2)} | FARANA HRS: ${faranaH.toFixed(2)} | FARANA DAYS: ${faranaD} | TOTAL ₹: ${totalAmt.toFixed(2)}`;
}

function getSelectedValues(id){
    return Array.from(document.getElementById(id).selectedOptions).map(o=>o.value);
}

function exportExcel(){
    if(rows.length===0){ alert("No data"); return;}
    const today=new Date().toISOString().split("T")[0];
    const ws=XLSX.utils.json_to_sheet(rows);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Worksheets");
    XLSX.writeFile(wb,`Bhavishya_Worksheet_${today}.xlsx`);
}

async function generatePDF(){

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("l","mm","a4");
    const today = new Date().toISOString().split("T")[0];

    const contractor = document.getElementById("pdf_contractor").value;
    const assign = document.getElementById("pdf_assign").value;
    const craneNo = document.getElementById("pdf_crane_no").value;
    const craneType = document.getElementById("pdf_crane_type").value;
    const fromDate = document.getElementById("pdf_from").value;
    const toDate = document.getElementById("pdf_to").value;

    let filtered = rows.filter(r =>
        (!contractor || r.contractor === contractor) &&
        (!assign || r.assign === assign) &&
        (!craneNo || r.crane_no === craneNo) &&
        (!craneType || r.crane_type === craneType) &&
        (!fromDate || r.work_date >= fromDate) &&
        (!toDate || r.work_date <= toDate)
    );


    if(filtered.length===0){ alert("No data"); return;}

    let y=15;
    const margin=10;
    const pageWidth=doc.internal.pageSize.getWidth();

    doc.setFontSize(14);
    doc.text("BHAVISHYA ENTERPRISE",pageWidth/2,y,{align:"center"});
    y+=8;

    doc.setFontSize(8);
    doc.text(`Filters: Contractor=${contractorList.join(",")||"ALL"} | Assign=${assignList.join(",")||"ALL"} | Crane=${craneList.join(",")||"ALL"} | Type=${typeList.join(",")||"ALL"} | From=${fromDate||"START"} To=${toDate||"END"}`,margin,y);
    y+=10;

    const rowHeight=7;
    const columns=["SR","Date","Client","Contractor","Crane","In","Out","Lunch","Hrs","Unit","Rate","Amount","PO"];
    const colWidth=[10,20,25,25,20,15,15,12,15,15,15,20,20];

    function drawRow(data,yPos){
        let x=margin;
        data.forEach((cell,i)=>{
            doc.rect(x,yPos,colWidth[i],rowHeight);
            doc.text(String(cell),x+2,yPos+5);
            x+=colWidth[i];
        });
    }

    drawRow(columns,y);
    y+=rowHeight;

    filtered.forEach((r,i)=>{
        if(y>180){ doc.addPage(); y=20; drawRow(columns,y); y+=rowHeight; }
        drawRow([
            i+1,
            r.work_date,
            r.client,
            r.contractor,
            r.crane_no,
            r.in_time,
            r.out_time,
            r.lunch,
            r.total_hours,
            r.unit,
            r.rate,
            Number(r.amount).toFixed(2),
            r.po
        ],y);
        y+=rowHeight;
    });

    doc.save(`Bhavishya_Report_${today}.pdf`);
}

function clearAll(){
    if(confirm("Clear all data?")){
        rows=[];
        localStorage.removeItem("rows");
        renderTable();
    }
}

document.querySelectorAll("input,select").forEach(el=>{
    el.addEventListener("input",calculate);
});

renderTable();

</script>
</body>
</html>
