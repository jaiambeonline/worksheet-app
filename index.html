<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Bhavishya Enterprise - Crane Worksheet</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { font-family:'Poppins',sans-serif; background:#f4f6f9; padding:15px; margin:0;}
.card { background:white; padding:18px; border-radius:14px; box-shadow:0 8px 25px rgba(0,0,0,0.08); margin-bottom:18px;}
.header { background:linear-gradient(135deg,#2b7cff,#004aad); color:white; text-align:center;}
.header h2 { margin:5px 0;}
.header p { margin:2px 0; font-size:13px;}
input,select { width:100%; padding:9px; margin:6px 0; border-radius:8px; border:1px solid #ccc;}
button { width:100%; padding:10px; margin-top:10px; border:none; border-radius:8px; font-weight:600; cursor:pointer;}
.primary { background:#2b7cff; color:white;}
.danger { background:#e74c3c; color:white;}
table { width:100%; border-collapse:collapse; font-size:12px;}
th,td { padding:8px; border-bottom:1px solid #eee;}
th { background:#fafafa; font-weight:600;}
.summary-box { background:#2b7cff; color:white; padding:14px; border-radius:10px; text-align:center; font-weight:600;}
</style>
</head>

<body>

<div class="card header">
<h2>BHAVISHYA ENTERPRISE</h2>
<p>Shop No 5, T M Park, Mukund Parnera</p>
<p>Valsad - 396020</p>
<p>M: 8866995757</p>
<p>bhavishyaenterprisevalsad@gmail.com</p>
</div>

<div class="card">
<h3>Worksheet Entry</h3>

<input type="date" id="work_date">
<input id="client" placeholder="Client">
<input id="contractor" placeholder="Contractor">

<select id="crane_type">
<option>HYDRA</option>
<option>FARANA</option>
</select>

<select id="crane_no">
<option>GJ15SV1249</option>
<option>GJ15SV1677</option>
<option>GJ15SV1316</option>
<option>GJ15SV1315</option>
<option>GJ15SV1314</option>
</select>

<input id="assign" placeholder="Assign Sir">
<input type="time" id="in_time">
<input type="time" id="out_time">
<input type="number" id="lunch" value="0" placeholder="Lunch (minutes)">

<select id="rate_type">
<option>Hourly</option>
<option>Fixed</option>
</select>

<input type="number" id="rate" placeholder="Rate">
<input id="total_hours" placeholder="Total Hours" readonly>
<input id="unit" placeholder="Unit" readonly>
<input id="amount" placeholder="Amount" readonly>

<button class="primary" onclick="addRow()">Add Worksheet</button>
</div>

<div class="summary-box" id="summary">
HYDRA HRS: 0 | FARANA HRS: 0 | FARANA DAYS: 0 | TOTAL ₹: 0
</div>

<div class="card">
<label>Select Contractor for PDF</label>
<select id="pdf_contractor">
<option value="">ALL</option>
</select>

<table id="table">
<thead>
<tr>
<th>Date</th>
<th>Client</th>
<th>Contractor</th>
<th>Crane</th>
<th>PO</th>
<th>Hours</th>
<th>Amount</th>
</tr>
</thead>
<tbody></tbody>
</table>

<button class="primary" onclick="exportExcel()">Export Excel</button>
<button class="primary" onclick="generatePDF()">Export Contractor PDF</button>
<button class="danger" onclick="clearAll()">Clear All</button>
</div>

<script>

let rows = JSON.parse(localStorage.getItem("rows") || "[]");

function calculate(){
    let client=document.getElementById("client").value.toUpperCase();
    let crane=document.getElementById("crane_type").value;
    let inTime=document.getElementById("in_time").value;
    let outTime=document.getElementById("out_time").value;
    let lunch=parseFloat(document.getElementById("lunch").value||0);
    let rateType=document.getElementById("rate_type").value;
    let rateField=document.getElementById("rate");

    if(!inTime||!outTime) return;

    let inDate=new Date("1970-01-01T"+inTime);
    let outDate=new Date("1970-01-01T"+outTime);
    if(outDate<inDate) outDate.setDate(outDate.getDate()+1);

    let hours=(outDate-inDate)/(1000*60*60)-lunch/60;
    hours=Math.max(hours,0);

    let amount=0,unit="",po="";

    if(client==="ATUL LTD"){
        rateField.readOnly=true;
        if(crane==="HYDRA"){
            rateField.value=750; unit="HOURS"; amount=hours*750; po="9119720043";
        }else{
            if(hours<7){
                rateField.value=1500; unit="HOURS"; amount=hours*1500; po="9719720185";
            }else{
                rateField.value=10000; unit="DAY"; amount=10000; po="9719720186";
            }
        }
    }else{
        rateField.readOnly=false;
        let rate=parseFloat(rateField.value||0);
        if(rateType==="Hourly"){ unit="HOURS"; amount=hours*rate;}
        else{ unit="FIXED"; amount=rate;}
    }

    document.getElementById("total_hours").value=hours.toFixed(2);
    document.getElementById("unit").value=unit;
    document.getElementById("amount").value=amount.toFixed(2);

    return {hours,amount,po};
}

function addRow(){

    let calc = calculate();

    let row = {
        work_date: document.getElementById("work_date").value,
        client: document.getElementById("client").value,
        contractor: document.getElementById("contractor").value,
        crane_type: document.getElementById("crane_type").value,
        crane_no: document.getElementById("crane_no").value,
        assign: document.getElementById("assign").value,
        in_time: document.getElementById("in_time").value,
        out_time: document.getElementById("out_time").value,
        lunch: document.getElementById("lunch").value,
        total_hours: document.getElementById("total_hours").value,
        unit: document.getElementById("unit").value,
        rate: document.getElementById("rate").value,
        amount: document.getElementById("amount").value,
        po: calc ? calc.po : ""
    };

    rows.push(row);
    localStorage.setItem("rows", JSON.stringify(rows));
    renderTable();
}


function renderTable(){
    let tbody=document.querySelector("#table tbody");
    tbody.innerHTML=rows.map(r=>`
        <tr>
        <td>${r.work_date}</td>
        <td>${r.client}</td>
        <td>${r.contractor}</td>
        <td>${r.crane_no}</td>
        <td>${r.po||""}</td>
        <td>${r.total_hours}</td>
        <td>${r.amount}</td>
        </tr>`).join("");

    let contractors=[...new Set(rows.map(r=>r.contractor))];
    document.getElementById("pdf_contractor").innerHTML=
        '<option value="">ALL</option>'+
        contractors.map(c=>`<option>${c}</option>`).join("");

    let hydra=0,faranaH=0,faranaD=0,totalAmt=0;
    rows.forEach(r=>{
        if(r.po==="9119720043") hydra+=parseFloat(r.total_hours||0);
        if(r.po==="9719720185") faranaH+=parseFloat(r.total_hours||0);
        if(r.po==="9719720186") faranaD+=1;
        totalAmt+=parseFloat(r.amount||0);
    });

    document.getElementById("summary").innerHTML=
    `HYDRA HRS: ${hydra.toFixed(2)} | FARANA HRS: ${faranaH.toFixed(2)} | FARANA DAYS: ${faranaD} | TOTAL ₹: ${totalAmt.toFixed(2)}`;
}

function exportExcel(){

    if(rows.length === 0){
        alert("No data");
        return;
    }

    const today = new Date().toISOString().split("T")[0];

    const data = rows.map(r => ({
        work_date: r.work_date || "",
        client_name: r.client || "",
        contractor_name: r.contractor || "",
        crane_type: r.crane_type || "",
        po_code: r.po || "",
        crane_number: r.crane_no || "",
        assign_sir: r.assign || "",
        in_time: r.in_time || "",
        out_time: r.out_time || "",
        lunch_minutes: r.lunch || 0,
        total_hours: parseFloat(r.total_hours || 0),
        unit_type: r.unit || "",
        rate: parseFloat(r.rate || 0),
        amount: parseFloat(r.amount || 0)
    }));

    const worksheet = XLSX.utils.json_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Worksheets");

    XLSX.writeFile(workbook, `Bhavishya_Worksheet_${today}.xlsx`);
}


async function generatePDF(){

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4");

    const contractor = document.getElementById("pdf_contractor").value;
    const today = new Date().toISOString().split("T")[0];

    let filtered = contractor 
        ? rows.filter(r => r.contractor === contractor)
        : rows;

    if(filtered.length === 0){
        alert("No data");
        return;
    }

    let y = 15;

    // ===== HEADER =====
    doc.setFontSize(14);
    doc.setFont(undefined, "bold");
    doc.text("BHAVISHYA ENTERPRISE", 105, y, { align: "center" });

    y += 6;
    doc.setFontSize(9);
    doc.setFont(undefined, "normal");
    doc.text("Shop No 5, T M Park, Mukund Parnera", 105, y, { align: "center" });
    y += 5;
    doc.text("Valsad - 396020 | M: 8866995757", 105, y, { align: "center" });
    y += 5;
    doc.text("bhavishyaenterprisevalsad@gmail.com", 105, y, { align: "center" });

    y += 5;
    doc.line(10, y, 200, y);

    y += 8;
    doc.setFontSize(11);
    doc.setFont(undefined, "bold");
    doc.text("WORKSHEET REPORT", 105, y, { align: "center" });

    y += 8;
    doc.setFont(undefined, "normal");
    doc.text("Contractor: " + (contractor || "ALL"), 10, y);
    doc.text("Date: " + today, 150, y);

    y += 8;

    // ===== TABLE SETTINGS =====
    const colX = {
        sr: 10,
        date: 18,
        client: 32,
        crane: 65,
        in: 85,
        out: 97,
        hrs: 110,
        rate: 125,
        amt: 150
    };

    const rowHeight = 6;

    // ===== TABLE HEADER =====
    doc.setFontSize(8);
    doc.setFont(undefined, "bold");

    doc.text("SR", colX.sr, y);
    doc.text("Date", colX.date, y);
    doc.text("Client", colX.client, y);
    doc.text("Crane", colX.crane, y);
    doc.text("In", colX.in, y);
    doc.text("Out", colX.out, y);
    doc.text("Hrs", colX.hrs, y);
    doc.text("Rate", colX.rate, y);
    doc.text("Amount", colX.amt, y);

    y += 2;
    doc.line(10, y, 200, y);
    y += 4;

    doc.setFont(undefined, "normal");

    let hydra=0, faranaH=0, faranaD=0, totalAmt=0;

    filtered.forEach((r,index)=>{

        if(y > 270){
            doc.addPage();
            y = 20;
        }

        // Table Row
        doc.text(String(index+1), colX.sr, y);
        doc.text(String(r.work_date), colX.date, y);
        doc.text(String(r.client).substring(0,15), colX.client, y);
        doc.text(String(r.crane_no), colX.crane, y);
        doc.text(String(r.in_time), colX.in, y);
        doc.text(String(r.out_time), colX.out, y);
        doc.text(String(r.total_hours), colX.hrs, y);

        doc.text(String(r.rate), colX.rate, y);

        // Right aligned amount
        doc.text("₹ " + Number(r.amount).toFixed(2), 195, y, { align: "right" });

        // Draw row line
        doc.line(10, y+2, 200, y+2);

        // Summary logic
        if(r.po==="9119720043") hydra += parseFloat(r.total_hours||0);
        if(r.po==="9719720185") faranaH += parseFloat(r.total_hours||0);
        if(r.po==="9719720186") faranaD += 1;
        totalAmt += parseFloat(r.amount||0);

        y += rowHeight;
    });

    y += 6;
    doc.line(10, y, 200, y);
    y += 6;

    doc.setFont(undefined, "bold");
    doc.text("PO WISE SUMMARY", 10, y);
    y += 6;

    doc.setFont(undefined, "normal");
    doc.text("HYDRA HOURS (9119720043): " + hydra.toFixed(2), 10, y);
    y += 5;
    doc.text("FARANA HOURS (9719720185): " + faranaH.toFixed(2), 10, y);
    y += 5;
    doc.text("FARANA DAYS (9719720186): " + faranaD, 10, y);
    y += 5;

    doc.setFont(undefined, "bold");
    doc.text("TOTAL AMOUNT: ₹ " + totalAmt.toFixed(2), 10, y);

    doc.save(`Bhavishya_${contractor || "ALL"}_${today}.pdf`);
}




function clearAll(){
    if(confirm("Clear all data?")){
        rows=[];
        localStorage.removeItem("rows");
        renderTable();
    }
}

document.querySelectorAll("input,select").forEach(el=>{
    el.addEventListener("input",calculate);
});

renderTable();

</script>
</body>
</html>
